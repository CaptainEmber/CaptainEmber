<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REM Ember</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <!-- <script src="/easyrtc/easyrtc.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/randomcolor/randomColor.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-audio-analyser@1.0.0/dist/aframe-audio-analyser.umd.js"></script>
  <link rel="stylesheet" href="style.css">

  <!-- Force HTTPS -->
  <script>
  if (window.location.protocol !== 'https:') {
    window.location.replace('https://' + window.location.hostname + window.location.pathname + window.location.search + window.location.hash);
  }
  </script>
</head>
<body>

  <a-scene reflection="directionalLight:a-light#dirlight;">
    <!-- all the assets -->
    <a-assets>
      <a-asset-item id="env-glb" src="mdl/start_004.glb"></a-asset-item>
      <a-asset-item id="dolphin" src="mdl/dolphinleap.glb"></a-asset-item>
      <img id="sky" src="img/clouds.jpg">
      <a-cubemap id="pan">
        <img src="img/panorama/px.jpg">
        <img src="img/panorama/nx.jpg">
        <img src="img/panorama/py.jpg">
        <img src="img/panorama/ny.jpg">
        <img src="img/panorama/pz.jpg">
        <img src="img/panorama/nz.jpg">
      </a-cubemap>
      <audio id="song" src="sfx/lovestep.mp3" autoplay loop></audio>
    </a-assets>

    <!-- Camera and controls -->
    <a-entity id="cameraRig" position="0 1.6 4" dynamic-body>
      <a-entity camera look-controls wasd-controls>
        <a-entity cursor="fuse: false; fuseTimeout: 1500"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: white; shader: flat"
          animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1"
          animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1">
        </a-entity>
      </a-entity>
    </a-entity>
    
    <!-- Environment GLB: start.glb -->
    <a-entity gltf-model="#env-glb" position="0 0 0" scale="1 1 1"></a-entity>
    <a-entity gltf-model="#dolphin" position="0 0 0" scale="1 1 1" animation-mixer="clip: leap" scale-on-mouseenter></a-entity>
    <a-sphere position="0 1 -2"
        material="envMap:#pan; metalness:1.0; roughness:0.0">
    </a-sphere>
    <!-- Sky -->
    <a-sky src="#sky" src="#sky"></a-sky>
    <a-light id="dirlight" intensity="1" light="castShadow:true;type:directional" position="1 1 1"></a-light>
    <a-light type="probe" envMap="#pan"></a-light>
    <!-- Avatar Template with Goofy Shape and Positional Audio -->
    <template id="avatar-template">
      <a-entity>
        <a-sphere id="head" radius="0.25"></a-sphere>
        <a-sphere id="nose" radius="0.08" position="0 0.1 0.23" color="#fff"></a-sphere>
        <a-sphere id="left-eye" radius="0.05" position="-0.08 0.18 0.22" color="#fff"></a-sphere>
        <a-sphere id="right-eye" radius="0.05" position="0.08 0.18 0.22" color="#fff"></a-sphere>
        <a-sphere id="left-pupil" radius="0.02" position="-0.08 0.18 0.27" color="#222"></a-sphere>
        <a-sphere id="right-pupil" radius="0.02" position="0.08 0.18 0.27" color="#222"></a-sphere>
        <a-entity id="mouth" geometry="primitive: torus; radius: 0.08; tube: 0.015; arc: 180" rotation="90 0 0" position="0 0.05 0.23" material="color: #f33"></a-entity>
        <!-- <a-entity id="audio" networked-audio-source position="0 0.25 0"></a-entity> -->
      </a-entity>
    </template>

    <!-- Add this inside your <a-scene> -->
    <a-link href="room2.html" position="0 1 -3" title="Go to Room 2"></a-link>

    <!-- Audio analyzer -->
    <a-entity id="audio-analyzer" audioanalyser="src: #song; smoothingTimeConstant: 0.9" position="0 0 0"></a-entity>

    <!-- Audio reactive object -->
    <a-entity
      geometry="primitive: icosahedron"
      material="color: #ff0000; metalness: 0.8; roughness: 0.2"
      position="0 1 0"
      audio-reactive="analyzerEl: #audio-analyzer; minHeight: 0; maxHeight: 3; minScale: 0.5; maxScale: 2">
    </a-entity>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Wait for A-Frame to be ready
      var scene = document.querySelector('a-scene');
      scene.addEventListener('loaded', function () {
        
        // Random avatar color
        AFRAME.registerComponent('random-avatar-color', {
          init: function () {
            var color = window.randomColor ? window.randomColor() : '#39c';
            var head = this.el.querySelector('#head');
            if (head) head.setAttribute('color', color);
          }
        });

        // Scale on mouse enter
        AFRAME.registerComponent('scale-on-mouseenter', {
          schema: {
            to: {default: '1.2 1.2 1.2', type: 'vec3'}
          },

          init: function () {
            var data = this.data;
            var el = this.el;
            this.el.addEventListener('mouseenter', function () {
              el.object3D.scale.copy(data.to);
            });
          }
        });

        // Add audio-reactive component
        AFRAME.registerComponent('audio-reactive', {
          schema: {
            analyzerEl: {type: 'selector', default: '[audioanalyser]'},
            minHeight: {default: 0},
            maxHeight: {default: 2},
            minScale: {default: 1},
            maxScale: {default: 2}
          },

          tick: function () {
            var analyzerEl = this.data.analyzerEl;
            if (!analyzerEl || !analyzerEl.components.audioanalyser) { return; }

            var analyzerComponent = analyzerEl.components.audioanalyser;
            var volume = analyzerComponent.volume;
            var frequencies = analyzerComponent.frequencies;
            
            // Get bass (first quarter of frequencies)
            var bass = 0;
            var length = Math.floor(frequencies.length / 4);
            for (var i = 0; i < length; i++) {
              bass += frequencies[i];
            }
            bass = bass / length / 255;

            // Apply transformations
            var height = this.data.minHeight + (volume * (this.data.maxHeight - this.data.minHeight));
            var scale = this.data.minScale + (bass * (this.data.maxScale - this.data.minScale));
            
            this.el.object3D.position.y = height;
            this.el.object3D.scale.set(scale, scale, scale);
          }
        });

      });
    });

  </script>
</body>
</html>
