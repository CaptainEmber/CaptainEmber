<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REM Ember</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/randomcolor/randomColor.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-audio-analyser@1.0.0/dist/aframe-audio-analyser.umd.js"></script>
  <link rel="stylesheet" href="style.css">

  <script>
      AFRAME.scenes[0].addEventListener('loaded', function () {
      var sceneEl = this;
      var renderer = sceneEl.renderer;
      var cubeMap = sceneEl.querySelector('#pan').__threeObj;
      if (renderer && cubeMap) {
        sceneEl.object3D.environment = cubeMap;
      }
   });
  </script>
  <!-- Force HTTPS -->
  <script>
  if (window.location.protocol !== 'https:') {
    window.location.replace('https://' + window.location.hostname + window.location.pathname + window.location.search + window.location.hash);
  }
  </script>
</head>
<body>

  <a-scene>
    <!-- all the assets -->
    <a-assets>
      <a-asset-item id="env-glb" src="mdl/start_004.glb"></a-asset-item>
      <a-asset-item id="dolphin" src="mdl/dolphinleap.glb"></a-asset-item>
      <img id="sky" src="img/clouds.jpg">
      <a-cubemap id="pan">
        <img src="img/panorama/px.jpg">
        <img src="img/panorama/nx.jpg">
        <img src="img/panorama/py.jpg">
        <img src="img/panorama/ny.jpg">
        <img src="img/panorama/pz.jpg">
        <img src="img/panorama/nz.jpg">
      </a-cubemap>
    </a-assets>

    <!-- Camera and controls -->
    <a-entity id="cameraRig" position="0 1.6 4" dynamic-body>
      <a-entity camera look-controls wasd-controls></a-entity>
    </a-entity>
    
    <!-- Environment GLB: start.glb -->
    <a-entity gltf-model="#env-glb" position="0 0 0" scale="1 1 1"></a-entity>
    <a-entity gltf-model="#dolphin" position="0 0 0" scale="1 1 1" animation-mixer="clip: leap"></a-entity>

    <!--
     <a-entity 
        gltf-model="#toy"
        cube-env-map="path: https://mkwy.fr/assets/cube-env/; extension: jpg; reflectivity: 0.9;" 
        play-all-model-animations >
     </a-entity>
     -->

    <!-- Sky -->
    <a-sky src="#sky" src="#sky"></a-sky>

    <!-- Link to audio analyzer -->
    <a-entity audioanalyser="src: #song;" component-that-does-stuff-with-audioanalyser-data></a-entity>

    <!-- Avatar Template with Goofy Shape and Positional Audio -->
    <template id="avatar-template">
      <a-entity>
        <a-sphere id="head" radius="0.25"></a-sphere>
        <a-sphere id="nose" radius="0.08" position="0 0.1 0.23" color="#fff"></a-sphere>
        <a-sphere id="left-eye" radius="0.05" position="-0.08 0.18 0.22" color="#fff"></a-sphere>
        <a-sphere id="right-eye" radius="0.05" position="0.08 0.18 0.22" color="#fff"></a-sphere>
        <a-sphere id="left-pupil" radius="0.02" position="-0.08 0.18 0.27" color="#222"></a-sphere>
        <a-sphere id="right-pupil" radius="0.02" position="0.08 0.18 0.27" color="#222"></a-sphere>
        <a-entity id="mouth" geometry="primitive: torus; radius: 0.08; tube: 0.015; arc: 180" rotation="90 0 0" position="0 0.05 0.23" material="color: #f33"></a-entity>
        <!-- <a-entity id="audio" networked-audio-source position="0 0.25 0"></a-entity> -->
      </a-entity>
    </template>

    <!-- Add this inside your <a-scene> -->
    <a-link id="roomLink" static-body href="room2.html" position="0 1 -3" title="Go to Room 2"></a-link>

  </a-scene>

      <script>
      // Assign a random color to the avatar's head on creation
      AFRAME.registerComponent('random-avatar-color', {
        init: function () {
          var color = window.randomColor ? window.randomColor() : '#39c';
          var head = this.el.querySelector('#head');
          if (head) head.setAttribute('color', color);
        }
      });
      // Attach to local avatar
      document.addEventListener('DOMContentLoaded', function () {
        var cameraRig = document.querySelector('#cameraRig');
        if (cameraRig) cameraRig.setAttribute('random-avatar-color', '');
      });

      // Listen for collisions on the camera rig
      document.querySelector('#cameraRig').addEventListener('collide', function (e) {
      // Check if collided with the link
      if (e.detail.body.el && e.detail.body.el.id === 'roomLink') {
      // Get the href attribute from the link
      var href = e.detail.body.el.getAttribute('href');
      if (href) window.location.href = href;
    }
  });
    </script>
    <script>
AFRAME.scenes[0].addEventListener('loaded', function () {
  var dolphinEl = document.querySelector('[gltf-model="#dolphin"]');
  if (!dolphinEl) return;
  dolphinEl.addEventListener('model-loaded', function () {
    // Get the cubemap texture from the a-cubemap asset
    var cubemap = document.querySelector('#pan').__threeObj;
    if (!cubemap) return;
    // Traverse the dolphin mesh and set envMap on all mesh materials
    dolphinEl.getObject3D('mesh').traverse(function (node) {
      if (node.isMesh && node.material) {
        node.material.envMap = cubemap;
        node.material.envMapIntensity = 1.0;
        node.material.metalness = 1.0;    // Make it shiny
        node.material.roughness = 0.1;    // Lower roughness for more reflection
        node.material.needsUpdate = true;
      }
    });
  });
});
</script>
    
</body>
</html>
